Be careful of stack empty, and do check the stack is empty at the end